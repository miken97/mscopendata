---
title: "MSC Open Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MSC Open Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(mscopendata)
```

The [OGC API - Features](https://github.com/opengeospatial/ogcapi-features)
(WFS 3) provides a specification to querying geospatial data.

  + Every URL is of the form `https://api.weather.gc.ca/{endpoints}`
    + Three endpoints:
      + Feature Collections, `collections`
      + SpatioTemporal Assets, `stac`
      + Processes, `processes`

  + Data is passed to the resource with query parameters.
  
  + Each resource has common query parameters: `f` and `limit`.
  
  + All endpoints return JSON, RDF (JSON-LD) and HTML data.'


See [OGC Documentation](https://docs.ogc.org/is/17-069r3/17-069r3.html#_collections_) for more information.


## Feature Collections

  + See [Section 7.13](https://docs.ogc.org/is/17-069r3/17-069r3.html#_collections_)

  + Path: `/collections`


### Feature Collection

  + See [Section 7.14](https://docs.ogc.org/is/17-069r3/17-069r3.html#_collection_)

  + Path: `/collections/{collection_id}`


#### Features

  + See [Section 7.15](https://docs.ogc.org/is/17-069r3/17-069r3.html#_items_)

  + Path: `/collections/{collection_id}/items`
  
  + Query Parameters:
  
    + `limit`
    + `bbox`
    + `datetime`
    + `properties` (filtering)


##### Feature

  + See [Section 7.16](https://docs.ogc.org/is/17-069r3/17-069r3.html#_feature_)

  + Path: `/collections/{collection_id}/items/{feature_id}`
  
  + `feature_id`: local identifier of the feature


```{r eval= F, echo = F}
library(tidyverse)
library(httr2)

# Each API endpoint (i.e. URL with parameters) becomes and R function with documented arguments.

# create a request that used the base API url
req <- request("https://api.weather.gc.ca")

resp <- req |>
  # add on `collections` path
  req_url_path_append("collections") |>
  # add query parameters `f` and `limit`
  req_url_query(`f` = "jsonld", `limit` = 10000) |>
  req_perform()

# result is returned as jsonld
resp |> resp_body_json() |> str()
resp |> resp_headers()

resp_jsonld <- resp |>
  resp_body_json()

resp_jsonld |> view()



## Core request function ----

geomet_ogc_api <- function(resource, ..., quantity) {



}


# create a request that used the base API url
req <- request("https://api.weather.gc.ca")

resp <- req |>
  # add on `collections` path
  req_url_path_append("collections", "climate-stations", "items") |>
  # add query parameters `f` and `limit`
  req_url_query(`f` = "json", `limit` = 10000, `bbox` = paste0(bbox, collapse = ",")) |>
  req_perform()

# result is returned as jsonld
resp_jsonld <- resp |>
  resp_body_json()

resp_jsonld


req <- request("https://api.weather.gc.ca") |>
  req_url_path_append("collections")

req

resp <- req |>
  req_perform() |>
  resp_body_json()

# collections resource objects will return `links` and `collections`
resp |> names()

bind_rows(resp$links)
as_tibble(resp$collections)

# Req.13: mandatory that the `links` property of the response contains:
resp$links[[1]] |> names()

seq_along(resp$links) |>
  map(~resp[["links"]][[.x]][["rel"]])
```

